# 性能测试报告

**rtp2httpd**、**[msd_lite](https://github.com/rozhuk-im/msd_lite)**、**[udpxy](https://github.com/pcherenkov/udpxy)** 和 **[tvgate](https://github.com/qist/tvgate)** 四款组播转单播程序性能对比。

## 测试环境

- **平台**: Ubuntu 24.04 on Apple M3 Max (Parallels Desktop 虚拟机)
- **架构**: aarch64 (所有程序均为本机编译的原生 arm64 二进制文件)
- **内核**: Linux 6.8.0-90-generic
- **单项测试时长**: 10 秒
- **测量方法**:
  - CPU: 使用 `top -b -n 2` 进行采样
  - 内存: 从 `/proc/[pid]/smaps_rollup` 读取 USS (Unique Set Size)
  - 如果存在 fork 后的子进程，所有父子进程的 CPU、内存分别求和作为总结果
- **测试版本**:
  - rtp2httpd: v3.7.0
  - msd_lite: commit 79a6c62 (2025-05-02)
  - udpxy: commit 56fc563 (2026-01-26)
  - tvgate: v2.1.8

## 测试场景

| 测试           | 描述                                                                    |
| -------------- | ----------------------------------------------------------------------- |
| **多流测试**   | 8 个客户端，每个请求不同的组播地址，单流约 40 Mbps（模拟 4K IPTV 码率） |
| **单流测试**   | 8 个客户端，全部请求相同的组播地址，单流约 40 Mbps                      |
| **高带宽测试** | 1 个客户端，单流约 400 Mbps                                             |

## 测试结果汇总

### CPU 使用率 (%)

| 程序          | 多流 (8个不同地址) | 单流 (8个相同地址) | 高带宽 (400 Mbps) |
| ------------- | ------------------ | ------------------ | ----------------- |
| **rtp2httpd** | 🏆 **38.00%**      | 🏆 **20.00%**      | 🏆 **30.23%**     |
| **msd_lite**  | 64.00%             | 20.75%             | 37.50%            |
| **udpxy**     | 254.00%            | 178.00%            | 34.50%            |
| **tvgate**    | 537.20%            | 112.00%            | 100.00%           |

### 内存使用 (MB)

| 程序          | 多流 (8个不同地址) | 单流 (8个相同地址) | 高带宽 (400 Mbps) |
| ------------- | ------------------ | ------------------ | ----------------- |
| **rtp2httpd** | 🏆 **4.75**        | 4.50               | 4.50              |
| **msd_lite**  | 10.25              | 🏆 **2.62**        | 🏆 **2.62**       |
| **udpxy**     | 13.53              | 13.53              | 3.33              |
| **tvgate**    | 297.36             | 53.81              | 57.56             |

## 详细测试结果

### 测试一：多流场景 (8个客户端，不同地址，约 40 Mbps)

每个客户端请求不同的组播地址 (239.81.0.1-8)，测试服务器处理多个独立流的能力。

| 指标     | rtp2httpd      | msd_lite | udpxy    | tvgate    |
| -------- | -------------- | -------- | -------- | --------- |
| CPU 平均 | 🏆 **38.00%**  | 64.00%   | 254.00%  | 537.20%   |
| CPU 峰值 | 🏆 **38.00%**  | 64.00%   | 270.00%  | 544.40%   |
| 内存平均 | 🏆 **4.75 MB** | 10.25 MB | 13.53 MB | 297.36 MB |

### 测试二：单流场景 (8个客户端，相同地址，约 40 Mbps)

8个客户端全部请求相同的组播地址，测试服务器的组播复用效率。

| 指标     | rtp2httpd     | msd_lite       | udpxy    | tvgate   |
| -------- | ------------- | -------------- | -------- | -------- |
| CPU 平均 | 🏆 **20.00%** | 20.75%         | 178.00%  | 112.00%  |
| CPU 峰值 | 🏆 **20.00%** | 23.50%         | 240.00%  | 114.00%  |
| 内存平均 | 4.50 MB       | 🏆 **2.62 MB** | 13.53 MB | 53.81 MB |

### 测试三：高带宽场景 (1个客户端，约 400 Mbps)

单客户端接收高带宽流 (50倍速回放 ≈ 400 Mbps)。

| 指标     | rtp2httpd     | msd_lite       | udpxy   | tvgate   |
| -------- | ------------- | -------------- | ------- | -------- |
| CPU 平均 | 🏆 **30.23%** | 37.50%         | 34.50%  | 100.00%  |
| CPU 峰值 | 🏆 **38.00%** | 40.00%         | 46.00%  | 102.00%  |
| 内存平均 | 4.50 MB       | 🏆 **2.62 MB** | 3.33 MB | 57.56 MB |

## 测试结论

**rtp2httpd** 在基准测试中展现出优异的综合性能：

- **CPU 效率最高**：在所有三个测试场景中均取得最低 CPU 使用率，多流场景下仅为 msd_lite 的 59%、udpxy 的 15%、tvgate 的 7%
- **多流处理能力突出**：同时处理 8 个独立 4K 组播流时，CPU 和内存占用均为最低，适合多频道 IPTV 网关场景
- **高带宽场景表现稳定**：400 Mbps 高码率下 CPU 占用仅 30%，留有充足的性能余量
- **内存占用合理**：约 4.5 MB 的固定内存占用（全默认参数下），在各场景下保持稳定，适合资源受限的嵌入式设备

相比 udpxy 的 fork-per-client 模型，rtp2httpd 采用更高效的事件驱动架构，在高并发场景下优势明显。相比 msd_lite，rtp2httpd 在 CPU 效率上更胜一筹，尤其在多流并发场景下差距显著。

## 运行基准测试

详见 [tools/README.md](../tools/README.md) 了解测试工具和方法。

快速运行：

```bash
cd tools
./benchmark.sh
```

测试结果保存至 `benchmark_results_YYYYMMDD_HHMMSS.txt`。
